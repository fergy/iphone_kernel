/**
 * Copyright (c) 2011 Richard Ian Taylor.
 *
 * This file is part of the iDroid Project. (http://www.idroidproject.org).
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */

#include <linux/device.h>
#include <linux/types.h>
#include <linux/platform_device.h>
#include <linux/gpio_keys.h>
#include <linux/input.h>
#include <asm/mach-types.h>
#include <asm/mach/arch.h>

#include <plat/display-pipe.h>
#include <plat/mipi_dsim.h>
#include <plat/cpu.h>
#include <mach/cpu.h>
#include <mach/time.h>
#include <mach/map.h>
#include <mach/gpio.h>
#include <mach/devices.h>

#include <mach/spi.h> // Semi-temporary
#include <linux/spi/spi.h> // same
#include <plat/zephyr2.h> // again

static struct s5l_clcd_info clcd_info = {
	.reset_pin = S5L8930_GPIO(0x206),
	.pull_pin = -1,

	.irq = IRQ_CLCD0,

	.dot_pitch = 326,

	.horizontal = { 71, 71, 73 },
	.vertical = { 12, 12, 16 },
};

static struct fb_videomode video_mode = {
	.xres = 640,
	.yres = 960,

	.pixclock = 51300000,

	.left_margin = 15,
	.right_margin = 14,
	.upper_margin = 12,
	.lower_margin = 12,

	.hsync_len = 1,
	.vsync_len = 16,

	.flag = 0xD,
};

static struct gpio_keys_button buttons[] = {
	[0] = {
		.type = EV_KEY,
		.code = KEY_ENTER,
		.gpio = S5L8930_GPIO(0x7),
		.desc = "Home",
	},
	[1] = {
		.type = EV_KEY,
		.code = KEY_ESC,
		.gpio = S5L8930_GPIO(0x1),
		.desc = "Hold",
	},
	[2] = {
		.type = EV_KEY,
		.code = KEY_VOLUMEUP,
		.gpio = S5L8930_GPIO(0x2),
		.desc = "Volume Up",
	},
	[3] = {
		.type = EV_KEY,
		.code = KEY_VOLUMEDOWN,
		.gpio = S5L8930_GPIO(0x3),
		.desc = "Volume Down",
	},
};

static char z2_cal[] = "\x4e\x49\x01\x01\x00\x01\x00\x01\x03\x43\x34\x34\x41\x38\x4e\x30\x4a\x59\x57\x44\x43\x54\x47\x41\x53\x4e\x4c\x00\x00\x00\x00\x00\x4d\x42\x23\x23\x23\x23\x23\x23\x23\x23\x23\x23\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x34\x34\x34\x34\x34\x34\x34\x34\x34\x34\x3a\x3a\x3a\x3a\x3a\x3a\x3a\x3a\x3a\x3a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xde\x02\xac\x02\xbd\x02\x64\x02\x58\x02\xb4\x02\x5e\x02\x94\x02\x96\x02\x00\x00\x00\x00\x00\x00\x02\x00\x01\x09\x01\x09\xce\x02\x01\x01\x0d\x08\x01\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x8a\x00\x03\x00\x43\x00\x00\x00\x00\x0f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";

static void mt_power(struct zephyr2_platform_data *_pdata, int _en)
{
	// TODO: implement power control.
}

static struct zephyr2_platform_data z2_data = {
	.power = mt_power,
	.reset_gpio = S5L8930_GPIO(0x204),
	.touch_gpio = S5L8930_GPIO(0x205),

	.calibration = z2_cal,
	.calibration_size = ARRAY_SIZE(z2_cal),
};

static struct spi_board_info __initdata spidevs[] = {
	{
		.bus_num = 1,
		.max_speed_hz = 4500000,
		.mode = SPI_MODE_3,
		.modalias = "zephyr2",
		.platform_data = &z2_data,
	},
};

static void __init ipt4g_init(void)
{
	s5l8930_init();

	s5l8930_register_h2fmi();

	//s5l8930_register_gpio_keys(buttons, ARRAY_SIZE(buttons));
	s5l8930_register_mipi_dsim(&video_mode, 2, 57, 1, 3);
	s5l8930_register_clcd(&video_mode, 24, &clcd_info);

	//spi_register_board_info(spidevs, ARRAY_SIZE(spidevs));
}

MACHINE_START(IPOD_TOUCH_4G, "Apple iPod Touch 4G")
	/* Maintainer: iDroid Project */
	.map_io		= s5l8930_map_io,
	.init_irq	= s5l8930_init_irq,
	.timer		= &s5l8930_timer,
	.init_machine	= ipt4g_init,
MACHINE_END
